<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Communication </title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="light">
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h1>ğŸ” Laugh with happiness</h1>
            <p>Enter the secret keyword to access your private space</p>
            <input type="password" class="login-input" id="keywordInput" placeholder="Enter keyword...">
            <button class="login-btn" onclick="login()">Enter Chat</button>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-layout">
            <!-- Left Sidebar -->
            <div class="sidebar">
                <h3>âœ¨ Features</h3>
                <button class="feature-btn active" onclick="switchFeature(event, 'chat')">ğŸ’¬ Chat</button>
                <button class="feature-btn" onclick="switchFeature(event, 'todos')">âœ… To-Do List</button>
                <button class="feature-btn" onclick="switchFeature(event, 'drawing')">ğŸ¨ Drawing Board</button>
                <button class="feature-btn" onclick="switchFeature(event, 'game')">ğŸ® Tic-Tac-Toe</button>
                <button class="feature-btn" onclick="switchFeature(event, 'mood')">ğŸ˜Š Mood Tracker</button>
                <button class="feature-btn" onclick="switchFeature(event, 'stats')">ğŸ“Š Statistics</button>
                <button class="feature-btn" onclick="switchFeature(event, 'gifs')">ğŸ¬ GIF Finder</button>
                <button class="feature-btn" onclick="logout()">ğŸšª Logout</button>
            </div>

            <!-- Main Chat Area -->
            <div class="main-chat">
                <div class="chat-header">
                    <div class="header-left">
                        <h2> Chat</h2>
                        <div class="online-status" id="onlineStatus">
                            <span class="status-dot offline"></span>
                            <span>Connecting...</span>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="icon-btn" onclick="toggleTheme()" title="Toggle Theme">ğŸŒ“</button>
                        <button class="icon-btn" onclick="toggleEmoji()" title="Emoji">ğŸ˜Š</button>
                        <button class="icon-btn" onclick="document.getElementById('fileInput').click()" title="Send Image">ğŸ–¼ï¸</button>
                        <button class="icon-btn" onclick="toggleSearch()" title="Search">ğŸ”</button>
                        <button class="icon-btn" onclick="clearChat()" title="Clear Chat">ğŸ—‘ï¸</button>
                    </div>
                </div>

                <div class="search-messages" id="searchBox" style="display: none; padding: 10px 20px;">
                    <input type="text" placeholder="Search messages..." oninput="searchMessages(this.value)">
                </div>

                <div class="messages-area" id="messagesArea">
                    <!-- Messages will appear here -->
                </div>

                <div class="typing-indicator" id="typingIndicator" style="opacity: 0;">
                    Friend is typing...
                </div>

                <div class="input-area">
                    <div class="input-wrapper">
                        <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1" onkeydown="handleKeyPress(event)" oninput="handleTyping()"></textarea>
                        <button class="send-btn" onclick="sendMessage()">â¤</button>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
             <!-- Toggle Button -->
<button id="togglePanelBtn" onclick="toggleRightPanel()">â©</button>

            <div class="right-panel">
                <div class="panel-section active" id="chatPanel">
                    <h3>ğŸ’¬ Active Chat</h3>
                    <p style="opacity: 0.7; margin-top: 10px;">Send messages, emojis, GIFs, and images to your friend in real-time!</p>
                </div>
                <div class="panel-section" id="todosPanel">
                    <h3>âœ… Shared To-Do List</h3>
                    <div id="todoList"></div>
                    <div class="add-todo">
                        <input type="text" id="todoInput" placeholder="Add new task...">
                        <button onclick="addTodo()">Add</button>
                    </div>
                </div>
                <div class="panel-section" id="drawingPanel">
                    <h3>ğŸ¨ Drawing Board</h3>
                    <div class="canvas-container">
                        <canvas id="drawingCanvas" width="300" height="300"></canvas>
                    </div>
                    <div class="canvas-controls">
                        <input type="color" class="color-picker" id="colorPicker" value="#6366f1">
                        <button class="feature-btn" style="flex: 1;" onclick="clearCanvas()">Clear</button>
                        <button class="feature-btn" style="flex: 1;" onclick="saveDrawing()">Send</button>
                    </div>
                </div>
                <div class="panel-section" id="gamePanel">
                    <h3>ğŸ® Tic-Tac-Toe</h3>
                    <p id="gameStatus">Your turn (X)</p>
                    <div class="game-board" id="gameBoard"></div>
                    <button class="feature-btn" style="margin-top: 15px;" onclick="resetGame()">New Game</button>
                </div>
                <div class="panel-section" id="moodPanel">
                    <h3>ğŸ˜Š How are you feeling?</h3>
                    <div class="mood-selector">
                        <button class="mood-btn" onclick="selectMood('ğŸ˜Š', 'Happy')">ğŸ˜Š</button>
                        <button class="mood-btn" onclick="selectMood('ğŸ˜¢', 'Sad')">ğŸ˜¢</button>
                        <button class="mood-btn" onclick="selectMood('ğŸ˜¡', 'Angry')">ğŸ˜¡</button>
                        <button class="mood-btn" onclick="selectMood('ğŸ˜´', 'Tired')">ğŸ˜´</button>
                        <button class="mood-btn" onclick="selectMood('ğŸ¤”', 'Thinking')">ğŸ¤”</button>
                        <button class="mood-btn" onclick="selectMood('ğŸ˜', 'Cool')">ğŸ˜</button>
                        <button class="mood-btn" onclick="selectMood('ğŸ¥³', 'Excited')">ğŸ¥³</button>
                        <button class="mood-btn" onclick="selectMood('ğŸ˜Œ', 'Peaceful')">ğŸ˜Œ</button>
                    </div>
                    <div id="moodHistory" style="margin-top: 20px;"></div>
                </div>
                <div class="panel-section" id="statsPanel">
                    <h3>ğŸ“Š Chat Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-card"> <div class="stat-value" id="totalMessages">0</div> <div class="stat-label">Total Messages</div> </div>
                        <div class="stat-card"> <div class="stat-value" id="todayMessages">0</div> <div class="stat-label">Today</div> </div>
                        <div class="stat-card"> <div class="stat-value" id="totalWords">0</div> <div class="stat-label">Words Sent</div> </div>
                        <div class="stat-card"> <div class="stat-value" id="avgMessageLength">0</div> <div class="stat-label">Avg Length</div> </div>
                    </div>
                </div>
                <div class="panel-section" id="gifsPanel">
                    <h3>ğŸ¬ Find GIFs</h3>
                    <div class="gif-search">
                        <input type="text" id="gifSearchInput" placeholder="Search GIFs..." onkeydown="if(event.key==='Enter') searchGifs()">
                        <button class="feature-btn" onclick="searchGifs()">Search</button>
                    </div>
                    <div class="gif-results" id="gifResults"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal -->
    <div class="modal-overlay" id="customModal">
        <div class="modal-box">
            <p id="modalMessage">Are you sure?</p>
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="modalCancel">Cancel</button>
                <button class="modal-btn confirm" id="modalConfirm">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Emoji Picker -->
    <div class="emoji-picker" id="emojiPicker"><div class="emoji-grid"></div></div>

    <!-- File Input -->
    <input type="file" id="fileInput" class="file-input" accept="image/*" onchange="handleFileUpload(event)">

    <!-- Notification Sound -->
    <audio class="notification-sound" id="notificationSound">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8ti" type="audio/wav">
    </audio>

    <!-- Firebase SDKs -->
     
    <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
  import { signInAnonymously } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
  import { doc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
    apiKey: "AIzaSyAbKjBBGN_OrVisRhU5oHJ4yh3jelbNHds",
    authDomain: "communication-fe41a.firebaseapp.com",
    projectId: "communication-fe41a",
    storageBucket: "communication-fe41a.firebasestorage.app",
    messagingSenderId: "558023886269",
    appId: "1:558023886269:web:6f068ea4cc5f33bf127ed4",
    measurementId: "G-FNTVNYZMNG"
  };

  // Initialize Firebase
    let app = initializeApp(firebaseConfig);
let auth = getAuth(app);
let db = getFirestore(app);

      //onAuth
      onAuthStateChanged(auth, (user) => {
  if (user) {
    window.userId = user.uid; // âœ… Makes userId globally accessible
    console.log("Signed in:", user.uid);
  } else {
    // Not signed in yetâ€”trigger anonymous sign-in
    signInAnonymously(auth)
      .then((result) => {
        window.userId = result.user.uid;
        console.log("Signed in anonymously:", result.user.uid);
      })
      .catch((error) => {
        showModal("Sign-in failed: " + error.message, null, true);
      });
  }
});

  
    

        // --- Giphy API Key (use a public key for demo purposes) ---
        const GIPHY_API_KEY = 'YOUR_GIPHY_API_KEY'; // Replace with your Giphy API key.

        const fullEmojiList = ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜š', 'ğŸ˜™', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”', 'ğŸ¤', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜’', 'ğŸ™„', 'ğŸ˜¬', 'ğŸ¤¥', 'ğŸ˜Œ', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜', 'ğŸ¤“', 'ğŸ§', 'ğŸ˜•', 'ğŸ˜Ÿ', 'ğŸ™', 'ğŸ˜®', 'ğŸ˜¯', 'ğŸ˜²', 'ğŸ˜³', 'ğŸ¥º', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ˜–', 'ğŸ˜£', 'ğŸ˜', 'ğŸ˜“', 'ğŸ˜©', 'ğŸ˜«', 'ğŸ¥±', 'ğŸ˜¤', 'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬', 'ğŸ‘', 'ğŸ‘', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤', 'ğŸ™', 'âœ¨', 'ğŸ’«', 'â­', 'ğŸŒŸ', 'âœ…', 'âŒ', 'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ‰', 'ğŸŠ', 'ğŸˆ', 'ğŸ', 'ğŸ€', 'ğŸ†', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ±', 'ğŸ®', 'ğŸ¯', 'ğŸ²', 'ğŸ°', 'ğŸ³'];
        const reactionEmojis = ['ğŸ˜€', 'ğŸ˜‚', 'â¤ï¸', 'ğŸ‘', 'ğŸ˜Š', 'ğŸ˜', 'ğŸ¤”', 'ğŸ˜­', 'ğŸ‰', 'ğŸ™', 'ğŸ”¥', 'ğŸ’¯', 'ğŸ¤£', 'ğŸ˜¢', 'ğŸ˜®', 'ğŸ˜', 'ğŸ˜‡', 'ğŸ¥³', 'âœ…', 'âŒ', 'âœ¨', 'â­', 'ğŸˆ', 'ğŸ', 'ğŸ‘‹', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘€', 'ğŸ¤¯', 'ğŸ˜±'];

        // --- Initialization ---
      async function init() {
    try {
        // Use the firebaseConfig you defined earlier
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);   // âœ… assign to global variable
        db = getFirestore(app); // âœ… assign to global variable
    } catch (error) {
        console.error("Firebase initialization failed:", error);
        showModal("Could not connect to the chat service. Please check the configuration.", null, true);
        return;
    }

}
       // --- Authentication ---
       let roomId; // âœ… Declare once

async function login() {
  if (!window.userId) {
    showModal("Still connecting to authentication service. Please wait a moment.", null, true);
    return;
  }

  const keyword = document.getElementById('keywordInput').value.trim();
  if (keyword === 'DISHU') {
    roomId = 'rooms';
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('chatContainer').style.display = 'block';
    await setupChatRoom();
    startAllListeners();
    playSound();
  } else {
    showModal("Incorrect keyword! Try again.", null, true);
  }
}


        async function setupChatRoom() {
            const roomDocRef = doc(db, `artifacts/${__app_id}/public/data/chatRooms`, roomId);
            await setDoc(roomDocRef, { createdAt: serverTimestamp() }, { merge: true });
            
            const userDocRef = doc(roomDocRef, 'users', userId);
            await setDoc(userDocRef, { lastSeen: serverTimestamp() });
            
            // Periodically update user's presence
            setInterval(() => {
                if (userId && roomId) {
                    const userPresenceRef = doc(db, `artifacts/${__app_id}/public/data/chatRooms/${roomId}/users`, userId);
                    setDoc(userPresenceRef, { lastSeen: serverTimestamp() });
                }
            }, 60 * 1000); // every minute
        }

        function logout() {
            showModal("Are you sure you want to logout?", () => {
                unsubscribeListeners.forEach(unsub => unsub());
                unsubscribeListeners = [];
                document.getElementById('chatContainer').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('keywordInput').value = '';
                roomId = null;
            });
        }
        
        // --- Real-time Listeners ---
        function startAllListeners() {
            if (!roomId) return;
            const roomDocRef = doc(db, `artifacts/${__app_id}/public/data/chatRooms`, roomId);

            // Messages Listener
            const messagesQuery = query(collection(roomDocRef, 'messages'), orderBy('timestamp', 'asc'));
            const unsubMessages = onSnapshot(messagesQuery, (snapshot) => {
                messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                refreshMessages();
                updateStats();
                if (snapshot.docChanges().some(change => change.type === 'added' && change.doc.data().senderId !== userId && !document.hidden)) {
                    playSound();
                }
            });

            // Todos Listener
            const todosQuery = query(collection(roomDocRef, 'todos'), orderBy('createdAt', 'desc'));
            const unsubTodos = onSnapshot(todosQuery, (snapshot) => {
                const todos = [];
                snapshot.forEach(doc => todos.push({ id: doc.id, ...doc.data() }));
                renderTodos(todos);
            });
            
            // Presence & Typing Listener
            const unsubPresence = onSnapshot(collection(roomDocRef, 'users'), (snapshot) => {
                allUsers = {};
                snapshot.forEach(doc => allUsers[doc.id] = doc.data());
                updatePresence();
            });
            
            const unsubTyping = onSnapshot(doc(roomDocRef, 'state', 'typing'), (doc) => {
                const typingUsers = doc.exists() ? doc.data() : {};
                const otherTypingUser = Object.keys(typingUsers).find(id => id !== userId && typingUsers[id]);
                document.getElementById('typingIndicator').style.opacity = otherTypingUser ? '1' : '0';
            });
            
            // Game State Listener
            const unsubGame = onSnapshot(doc(roomDocRef, 'state', 'tic-tac-toe'), (doc) => {
                const gameState = doc.exists() ? doc.data() : { board: Array(9).fill(''), currentPlayer: 'X', active: true };
                renderGame(gameState);
            });

            unsubscribeListeners.push(unsubMessages, unsubTodos, unsubPresence, unsubTyping, unsubGame);
        }
        
        // --- Chat Functions ---
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (text) {
                const messagesColRef = collection(db, `artifacts/${__app_id}/public/data/chatRooms/${roomId}/messages`);
                await addDoc(messagesColRef, {
                    text: text,
                    senderId: userId,
                    timestamp: serverTimestamp(),
                    reactions: {}
                });
                input.value = '';
                input.style.height = 'auto';
            }
        }

        function refreshMessages() {
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.innerHTML = '';
            messages.forEach(msg => displayMessage(msg));
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function displayMessage(message) {
            if (!message.timestamp) return; // Don't display messages that are still being written to server
            const messagesArea = document.getElementById('messagesArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.senderId === userId ? 'sent' : 'received'}`;
            
            const reactions = message.reactions || {};
            let reactionsHtml = Object.keys(reactions).length > 0 ? '<div class="message-reactions">' : '';
            for (const [emoji, users] of Object.entries(reactions)) {
                if (users.length > 0) {
                    reactionsHtml += `<span class="reaction">${emoji} ${users.length}</span>`;
                }
            }
            if (reactionsHtml) reactionsHtml += '</div>';

            const time = message.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            messageDiv.innerHTML = `
                <div class="message-content">
                    ${message.image ? `<img src="${message.image}" class="message-image" alt="Shared content">` : ''}
                    ${message.text}
                    <span class="message-time">${time}</span>
                </div>
                ${reactionsHtml}
                <div class="message-actions">
                    ${reactionEmojis.slice(0, 4).map(e => `<button class="msg-action-btn" onclick="reactToMessage('${message.id}', '${e}')">${e}</button>`).join('')}
                    <button class="msg-action-btn" onclick="deleteMessage('${message.id}', '${message.senderId}')">ğŸ—‘ï¸</button>
                </div>`;
            messagesArea.appendChild(messageDiv);
        }
        
        async function reactToMessage(messageId, emoji) {
            const msgRef = doc(db, `artifacts/${__app_id}/public/data/chatRooms/${roomId}/messages`, messageId);
            const msgDoc = await getDoc(msgRef);
            if(!msgDoc.exists()) return;
            const reactions = msgDoc.data().reactions || {};

            if (reactions[emoji] && reactions[emoji].includes(userId)) {
                 reactions[emoji] = reactions[emoji].filter(uid => uid !== userId); // Un-react
            } else {
                if (!reactions[emoji]) reactions[emoji] = [];
                reactions[emoji].push(userId); // React
            }
            
            await updateDoc(msgRef, { [`reactions.${emoji}`]: reactions[emoji] });
        }

        function deleteMessage(messageId, senderId) {
            if (senderId !== userId) {
                showModal("You can only delete your own messages.", null, true);
                return;
            }
            showModal("Delete this message?", async () => {
                const msgRef = doc(db, `artifacts/${__app_id}/public/data/chatRooms/${roomId}/messages`, messageId);
                await deleteDoc(msgRef);
            });
        }
        
        function clearChat() {
             showModal("Clear all messages? This cannot be undone.", async () => {
                const messagesRef = collection(db, `artifacts/${__app_id}/public/data/chatRooms/${roomId}/messages`);
                const q = query(messagesRef);
                const querySnapshot = await getDocs(q);
                const batch = writeBatch(db);
                querySnapshot.docs.forEach(d => batch.delete(d.ref));
                await batch.commit();
            });
        }

        // --- Typing & Presence ---
        async function handleTyping() {
            const input = document.getElementById('messageInput');
            input.style.height = 'auto';
            input.style.height = input.scrollHeight + 'px';
            
            const typingRef = doc(db, `artifacts/${__app_id}/public/data/chatRooms/${roomId}/state/typing`);
            await setDoc(typingRef, { [userId]: true }, { merge: true });

            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(async () => {
                await setDoc(typingRef, { [userId]: false }, { merge: true });
            }, 2000);
        }

        function updatePresence() {
            const onlineStatusDiv = document.getElementById('onlineStatus');
            const otherUserId = Object.keys(allUsers).find(id => id !== userId);
            let statusText = "You're alone";
            let dotClass = "offline";
            
            if (otherUserId) {
                const fiveMinutesAgo = Date.now() - 5 * 60 * 1000;
                if (allUsers[otherUserId].lastSeen.toMillis() > fiveMinutesAgo) {
                    statusText = "Both Online";
                    dotClass = ""; // Green
                } else {
                    statusText = "Friend Offline";
                }
            }
            onlineStatusDiv.innerHTML = `<span class="status-dot ${dotClass}"></span><span>${statusText}</span>`;
        }

        // --- To-Do List ---
        async function addTodo() {
            const input = document.getElementById('todoInput');
            const text = input.value.trim();
            if(text) {
                const todosColRef = collection(db, `artifacts/${__app_id}/public/data/chatRooms/${roomId}/todos`);
                await addDoc(todosColRef, { text, completed: false, createdAt: serverTimestamp() });
                input.value = '';
            }
        }
        
        async function toggleTodo(id, completed) {
            const todoRef = doc(db, `artifacts/${__app_id}/public/data/chatRooms/${roomId}/todos`, id);
            await updateDoc(todoRef, { completed: !completed });
        }

        async function deleteTodo(id) {
            const todoRef = doc(db, `artifacts/${__app_id}/public/data/chatRooms/${roomId}/todos`, id);
            await deleteDoc(todoRef);
        }

        function renderTodos(todos) {
            const todoList = document.getElementById('todoList');
            todoList.innerHTML = '';
            todos.forEach(todo => {
                const item = document.createElement('div');
                item.className = `todo-item ${todo.completed ? 'completed' : ''}`;
                item.innerHTML = `
                    <input type="checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleTodo('${todo.id}', ${todo.completed})">
                    <span style="flex: 1;">${todo.text}</span>
                    <button class="msg-action-btn" onclick="deleteTodo('${todo.id}')">ğŸ—‘ï¸</button>`;
                todoList.appendChild(item);
            });
        }
        
        // --- Tic-Tac-Toe ---
        function initGameBoard() {
            const boardDiv = document.getElementById('gameBoard');
            boardDiv.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('button');
                cell.className = 'game-cell';
                cell.onclick = () => makeMove(i);
                boardDiv.appendChild(cell);
            }
        }

        async function makeMove(index) {
            const gameRef = doc(db, `artifacts/${__app_id}/public/data/chatRooms/${roomId}/state/tic-tac-toe`);
            const gameDoc = await getDoc(gameRef);
            let { board, currentPlayer, active } = gameDoc.exists() ? gameDoc.data() : { board: Array(9).fill(''), currentPlayer: 'X', active: true };

            if (board[index] === '' && active) {
                board[index] = currentPlayer;
                const winner = checkWinner(board);
                
                if (winner) {
                    active = false;
                } else if (board.every(cell => cell !== '')) {
                    active = false; // Draw
                } else {
                    currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
                }

                await setDoc(gameRef, { board, currentPlayer, active });
            }
        }

        function checkWinner(board) {
            const winPatterns = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
                [0, 4, 8], [2, 4, 6]             // Diagonals
            ];
            for (const pattern of winPatterns) {
                const [a, b, c] = pattern;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    return board[a]; // Returns 'X' or 'O'
                }
            }
            return null; // No winner
        }

        function renderGame(gameState) {
            const { board, currentPlayer, active } = gameState;
            const cells = document.querySelectorAll('.game-cell');
            cells.forEach((cell, index) => cell.textContent = board[index]);
            
            const status = document.getElementById('gameStatus');
            const winner = checkWinner(board);
            if(winner) {
                status.textContent = `Player ${winner} wins! ğŸ‰`;
            } else if (!active && board.every(c => c)) {
                status.textContent = "It's a draw! ğŸ¤";
            } else {
                status.textContent = `Player ${currentPlayer}'s turn`;
            }
        }

        async function resetGame() {
            const gameRef = doc(db, `artifacts/${__app_id}/public/data/chatRooms/${roomId}/state/tic-tac-toe`);
            await setDoc(gameRef, { board: Array(9).fill(''), currentPlayer: 'X', active: true });
        }
        
        // --- GIF Search ---
        async function searchGifs() {
            const query = document.getElementById('gifSearchInput').value;
            const resultsDiv = document.getElementById('gifResults');
            resultsDiv.innerHTML = 'Searching...';

            if (!query) {
                resultsDiv.innerHTML = '<p>Enter a search term</p>';
                return;
            }
            if(GIPHY_API_KEY === 'YOUR_GIPHY_API_KEY') {
                resultsDiv.innerHTML = '<p style="color:red;">Giphy API Key not set.</p>';
                return;
            }
            
            try {
                const response = await fetch(`https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(query)}&limit=10`);
                const json = await response.json();
                resultsDiv.innerHTML = '';
                json.data.forEach(gif => {
                    const img = document.createElement('img');
                    img.src = gif.images.fixed_height_small.url;
                    img.onclick = () => sendGif(gif.images.original.url);
                    resultsDiv.appendChild(img);
                });
            } catch (e) {
                resultsDiv.innerHTML = '<p>Could not fetch GIFs.</p>';
                console.error(e);
            }
        }
        
        async function sendGif(gifUrl) {
            const messagesColRef = collection(db, `artifacts/${__app_id}/public/data/chatRooms/${roomId}/messages`);
            await addDoc(messagesColRef, {
                text: '',
                image: gifUrl,
                senderId: userId,
                timestamp: serverTimestamp(),
                reactions: {}
            });
        }
        
        // --- Utility & UI Functions ---
        function showModal(message, onConfirmCallback = null, isAlert = false) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalMessage').textContent = message;
            const confirmBtn = document.getElementById('modalConfirm');
            const cancelBtn = document.getElementById('modalCancel');

            confirmBtn.style.display = isAlert ? 'none' : 'inline-block';
            cancelBtn.textContent = isAlert ? 'OK' : 'Cancel';
            
            modal.classList.add('visible');

            const confirmHandler = () => {
                if (onConfirmCallback) onConfirmCallback();
                closeModal();
            };
            const cancelHandler = () => closeModal();

            confirmBtn.onclick = confirmHandler;
            cancelBtn.onclick = cancelHandler;

            function closeModal() {
                modal.classList.remove('visible');
                confirmBtn.onclick = null;
                cancelBtn.onclick = null;
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            document.body.classList.toggle('light');
            localStorage.setItem('dishu_theme', document.body.className);
        }

        function loadTheme() {
            const theme = localStorage.getItem('dishu_theme');
            if(theme) document.body.className = theme;
        }

        function playSound() { document.getElementById('notificationSound').play().catch(e => {}); }

        function handleKeyPress(event) { if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }}

        function switchFeature(event, feature) {
            document.querySelectorAll('.feature-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.panel-section').forEach(p => p.classList.remove('active'));
            document.getElementById(feature + 'Panel').classList.add('active');
            if (feature === 'stats') updateStats();
        };

        function toggleEmoji() { document.getElementById('emojiPicker').classList.toggle('show'); }

        function toggleSearch() {
            const searchBox = document.getElementById('searchBox');
            searchBox.style.display = searchBox.style.display === 'none' ? 'block' : 'none';
        }

        function searchMessages(query) {
            const messagesArea = document.getElementById('messagesArea');
            const allMessages = messagesArea.querySelectorAll('.message');
            allMessages.forEach(msg => {
                const text = msg.textContent.toLowerCase();
                if (text.includes(query.toLowerCase()) || query === '') {
                    msg.style.display = 'flex';
                } else {
                    msg.style.display = 'none';
                }
            });
        }

        // --- Partially implemented features (using local state or sending as messages) ---
        let canvas, ctx, isDrawing = false;
        function initCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
        }
        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }
        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            ctx.strokeStyle = document.getElementById('colorPicker').value;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
        }
        function stopDrawing() { isDrawing = false; }
        function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }
        
        async function saveDrawing() {
            const dataURL = canvas.toDataURL();
            const messagesColRef = collection(db, `artifacts/${__app_id}/public/data/chatRooms/${roomId}/messages`);
            await addDoc(messagesColRef, {
                text: 'ğŸ¨ Shared a drawing',
                image: dataURL,
                senderId: userId,
                timestamp: serverTimestamp(),
                reactions: {}
            });
            showModal("Drawing sent!", null, true);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const messagesColRef = collection(db, `artifacts/${__app_id}/public/data/chatRooms/${roomId}/messages`);
                    await addDoc(messagesColRef, {
                        text: 'ğŸ“· Shared an image',
                        image: e.target.result,
                        senderId: userId,
                        timestamp: serverTimestamp(),
                        reactions: {}
                    });
                };
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        }

        async function selectMood(emoji, moodName) {
            const messagesColRef = collection(db, `artifacts/${__app_id}/public/data/chatRooms/${roomId}/messages`);
            await addDoc(messagesColRef, {
                text: `Feeling ${moodName} ${emoji}`,
                senderId: userId,
                timestamp: serverTimestamp(),
                reactions: {}
            });
        }

        function populateEmojiPicker() {
            const grid = document.querySelector('.emoji-grid');
            grid.innerHTML = '';
            fullEmojiList.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-btn';
                btn.textContent = emoji;
                btn.onclick = () => insertEmoji(emoji);
                grid.appendChild(btn);
            });
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            input.value += emoji;
            input.focus();
        }
        
        function updateStats() {
            const today = new Date().toDateString();
            const todayMessages = messages.filter(m => {
                if (!m.timestamp) return false;
                return m.timestamp.toDate().toDateString() === today;
            });
            
            const totalWords = messages.reduce((sum, msg) => {
                return sum + (msg.text ? msg.text.split(' ').length : 0);
            }, 0);
            
            const avgLength = messages.length > 0 ? Math.round(totalWords / messages.length) : 0;
            
            document.getElementById('totalMessages').textContent = messages.length;
            document.getElementById('todayMessages').textContent = todayMessages.length;
            document.getElementById('totalWords').textContent = totalWords;
            document.getElementById('avgMessageLength').textContent = avgLength;
        }

        // Expose functions to global scope for HTML onclick handlers
        window.login = login;
        window.logout = logout;
        window.switchFeature = switchFeature;
        window.toggleTheme = toggleTheme;
        window.toggleEmoji = toggleEmoji;
        window.toggleSearch = toggleSearch;
        window.clearChat = clearChat;
        window.searchMessages = searchMessages;
        window.handleKeyPress = handleKeyPress;
        window.handleTyping = handleTyping;
        window.sendMessage = sendMessage;
        window.addTodo = addTodo;
        window.toggleTodo = toggleTodo;
        window.deleteTodo = deleteTodo;
        window.clearCanvas = clearCanvas;
        window.saveDrawing = saveDrawing;
        window.resetGame = resetGame;
        window.makeMove = makeMove;
        window.selectMood = selectMood;
        window.searchGifs = searchGifs;
        window.handleFileUpload = handleFileUpload;
        window.reactToMessage = reactToMessage;
        window.deleteMessage = deleteMessage;
        
        // Initialize on load
        window.onload = init;

        
    </script>
    
</body>
</html>

